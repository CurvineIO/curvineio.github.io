"use strict";(self.webpackChunkcurvine_doc=self.webpackChunkcurvine_doc||[]).push([[5699],{4811:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>p});const a=JSON.parse('{"id":"User-Manuals/K8S-CSI-Driver/Deployment","title":"Using Dynamic PV in Deployment","description":"Deployment is suitable for stateless applications where multiple replicas share the same storage.","source":"@site/docs/3-User-Manuals/5-K8S-CSI-Driver/02-Deployment.md","sourceDirName":"3-User-Manuals/5-K8S-CSI-Driver","slug":"/User-Manuals/K8S-CSI-Driver/Deployment","permalink":"/docs/User-Manuals/K8S-CSI-Driver/Deployment","draft":false,"unlisted":false,"editUrl":"https://github.com/curvineio/curvine-doc/edit/main/docs/3-User-Manuals/5-K8S-CSI-Driver/02-Deployment.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"K8S CSI Driver","permalink":"/docs/User-Manuals/K8S-CSI-Driver/Setup"},"next":{"title":"Using Dynamic PV in StatefulSet","permalink":"/docs/User-Manuals/K8S-CSI-Driver/StatefulSet"}}');var s=t(4848),r=t(8453);const i={},l="Using Dynamic PV in Deployment",o={},p=[{value:"Architecture Pattern",id:"architecture-pattern",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"Deploy and Verify",id:"deploy-and-verify",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"using-dynamic-pv-in-deployment",children:"Using Dynamic PV in Deployment"})}),"\n",(0,s.jsx)(n.p,{children:"Deployment is suitable for stateless applications where multiple replicas share the same storage."}),"\n",(0,s.jsx)(n.h2,{id:"architecture-pattern",children:"Architecture Pattern"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"           Deployment (3 replicas)\n               /      |      \\\n            Pod-1  Pod-2  Pod-3\n               \\      |      /\n                Single PVC (RWX)\n                      |\n              Curvine Volume (Shared)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# deployment-with-pvc.yaml\n---\n# 1. Create shared PVC\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: shared-data-pvc\n  namespace: default\nspec:\n  storageClassName: curvine-sc\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 10Gi\n\n---\n# 2. Create Deployment\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-app\n  namespace: default\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web-app\n  template:\n    metadata:\n      labels:\n        app: web-app\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:alpine\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: shared-storage\n          mountPath: /usr/share/nginx/html\n        command:\n        - /bin/sh\n        - -c\n        - |\n          if [ ! -f /usr/share/nginx/html/index.html ]; then\n            echo \"<h1>App initialized by command</h1>\" > /usr/share/nginx/html/index.html\n          fi\n          exec nginx -g 'daemon off;'\n        livenessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 10\n        readinessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 5\n      volumes:\n      - name: shared-storage\n        persistentVolumeClaim:\n          claimName: shared-data-pvc  # Share the same PVC\n\n---\n# 3. Create Service\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-app-service\n  namespace: default\nspec:\n  selector:\n    app: web-app\n  ports:\n  - port: 80\n    targetPort: 80\n  type: ClusterIP\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["For Deployment applications, Kubernetes is natively positioned for stateless services, meaning all replica Pods by default read and write to the same PV path. If your application requires different path isolation on Curvine, you can try using OpenKruise's ",(0,s.jsx)(n.code,{children:"CloneSets"})," as an alternative, which supports VolumeClaimTemplates. Reference: ",(0,s.jsx)(n.a,{href:"https://openkruise.io/zh/docs/user-manuals/cloneset",children:"https://openkruise.io/zh/docs/user-manuals/cloneset"})]})}),"\n",(0,s.jsx)(n.h2,{id:"deploy-and-verify",children:"Deploy and Verify"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. Deploy application\nkubectl apply -f deployment-with-pvc.yaml\n\n# 2. Check PVC status\nkubectl get pvc shared-data-pvc\n\n# 3. Check all Pods\nkubectl get pods -l app=web-app -o wide\n\n# 4. Verify all Pods mounted the same PVC\nkubectl get pods -l app=web-app -o jsonpath='{range .items[*]}{.metadata.name}{\"\\t\"}{.spec.volumes[0].persistentVolumeClaim.claimName}{\"\\n\"}{end}'\n\n# 5. Write data in one Pod\nPOD1=$(kubectl get pod -l app=web-app -o jsonpath='{.items[0].metadata.name}')\nkubectl exec $POD1 -- sh -c 'echo \"Hello from Pod 1\" > /usr/share/nginx/html/test.html'\n\n# 6. Read data in another Pod (verify sharing)\nPOD2=$(kubectl get pod -l app=web-app -o jsonpath='{.items[1].metadata.name}')\nkubectl exec $POD2 -- cat /usr/share/nginx/html/test.html\n# Should output: Hello from Pod 1\n\n# 7. Verify Service access\nkubectl run curl-test --image=curlimages/curl --rm -it --restart=Never -- curl http://web-app-service/test.html\n"})})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var a=t(6540);const s={},r=a.createContext(s);function i(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);