"use strict";(self.webpackChunkcurvine_doc=self.webpackChunkcurvine_doc||[]).push([[5828],{3703:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>o,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"User-Manuals/K8S-CSI-Driver/StatefulSet","title":"Using Dynamic PV in StatefulSet","description":"StatefulSet is suitable for stateful applications, where each Pod has independent persistent storage.","source":"@site/docs/3-User-Manuals/5-K8S-CSI-Driver/03-StatefulSet.md","sourceDirName":"3-User-Manuals/5-K8S-CSI-Driver","slug":"/User-Manuals/K8S-CSI-Driver/StatefulSet","permalink":"/docs/User-Manuals/K8S-CSI-Driver/StatefulSet","draft":false,"unlisted":false,"editUrl":"https://github.com/curvineio/curvine-doc/edit/main/docs/3-User-Manuals/5-K8S-CSI-Driver/03-StatefulSet.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Using Dynamic PV in Deployment","permalink":"/docs/User-Manuals/K8S-CSI-Driver/Deployment"},"next":{"title":"Curvine CSI Architecture","permalink":"/docs/User-Manuals/K8S-CSI-Driver/Framework"}}');var s=a(4848),r=a(8453);const i={},l="Using Dynamic PV in StatefulSet",c={},d=[{value:"Architecture Pattern",id:"architecture-pattern",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"Deploy and Verify",id:"deploy-and-verify",level:2},{value:"StatefulSet Features",id:"statefulset-features",level:2},{value:"PVC Naming Convention",id:"pvc-naming-convention",level:3},{value:"Pod and PVC Lifecycle",id:"pod-and-pvc-lifecycle",level:3},{value:"Scaling",id:"scaling",level:3},{value:"FUSE Process Sharing",id:"fuse-process-sharing",level:3}];function p(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"using-dynamic-pv-in-statefulset",children:"Using Dynamic PV in StatefulSet"})}),"\n",(0,s.jsx)(n.p,{children:"StatefulSet is suitable for stateful applications, where each Pod has independent persistent storage."}),"\n",(0,s.jsx)(n.h2,{id:"architecture-pattern",children:"Architecture Pattern"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        StatefulSet (3 replicas)\n            |         |         |\n         Pod-0     Pod-1     Pod-2\n            |         |         |\n         PVC-0     PVC-1     PVC-2\n            |         |         |\n          PV-0      PV-1      PV-2\n            |         |         |\n     /path/pvc-0  /path/pvc-1  /path/pvc-2\n"})}),"\n",(0,s.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# statefulset-web-app.yaml\n---\n# 1. Headless Service (required)\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-app-service\n  namespace: default\nspec:\n  clusterIP: None                # Headless Service\n  selector:\n    app: web-app\n  ports:\n  - port: 80\n    name: web\n\n---\n# 2. StatefulSet with VolumeClaimTemplates\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: web-app\n  namespace: default\nspec:\n  serviceName: web-app-service   # Must specify Service\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web-app\n  template:\n    metadata:\n      labels:\n        app: web-app\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:alpine\n        ports:\n        - containerPort: 80\n          name: web\n        volumeMounts:\n        - name: data                # Must match volumeClaimTemplates name\n          mountPath: /usr/share/nginx/html\n        command:\n        - /bin/sh\n        - -c\n        - |\n          # Write hello world message with pod name\n          echo "<h1>Hello from $(hostname)</h1>" > /usr/share/nginx/html/index.html\n          echo "<p>This is my persistent storage!</p>" >> /usr/share/nginx/html/index.html\n          echo "<p>Created at: $(date)</p>" >> /usr/share/nginx/html/index.html\n          # Start nginx\n          nginx -g \'daemon off;\'\n  # Key: VolumeClaimTemplates\n  volumeClaimTemplates:\n  - metadata:\n      name: data                    # PVC name prefix\n    spec:\n      storageClassName: curvine-sc\n      accessModes:\n        - ReadWriteOnce             # Independent storage for each Pod\n      resources:\n        requests:\n          storage: 1Gi\n'})}),"\n",(0,s.jsx)(n.h2,{id:"deploy-and-verify",children:"Deploy and Verify"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. Deploy StatefulSet\nkubectl apply -f statefulset-web-app.yaml\n\n# 2. Watch Pod creation order (created sequentially)\nkubectl get pods -l app=web-app -w\n\n# 3. Check PVCs (auto-created, one per Pod)\nkubectl get pvc\n# Example output:\n# data-web-app-0   Bound    pvc-xxx   1Gi       RWO\n# data-web-app-1   Bound    pvc-yyy   1Gi       RWO\n# data-web-app-2   Bound    pvc-zzz   1Gi       RWO\n\n# 4. Check PVs (auto-created)\nkubectl get pv\n\n# 5. Verify each Pod has independent storage\nfor i in 0 1 2; do\n  echo \"=== Pod web-app-$i ===\"\n  kubectl exec web-app-$i -- cat /usr/share/nginx/html/index.html\ndone\n\n# 6. Write custom data to Pod-0\nkubectl exec web-app-0 -- sh -c \\\n  'echo \"<p>Custom data from Pod-0</p>\" >> /usr/share/nginx/html/index.html'\n\n# 7. Verify Pod-0's data\nkubectl exec web-app-0 -- cat /usr/share/nginx/html/index.html\n\n# 8. Verify Pod-1 doesn't have Pod-0's custom data (independent storage)\nkubectl exec web-app-1 -- cat /usr/share/nginx/html/index.html\n\n# 9. Test persistence: Data remains after deleting Pod-0\nkubectl delete pod web-app-0\n# Wait for Pod to be recreated\nkubectl wait --for=condition=Ready pod/web-app-0 --timeout=60s\n# Verify data still exists\nkubectl exec web-app-0 -- cat /usr/share/nginx/html/index.html\n"})}),"\n",(0,s.jsx)(n.h2,{id:"statefulset-features",children:"StatefulSet Features"}),"\n",(0,s.jsx)(n.h3,{id:"pvc-naming-convention",children:"PVC Naming Convention"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'PVC name = volumeClaimTemplate.name + "-" + StatefulSet.name + "-" + Pod ordinal\n\nExample:\ndata-web-app-0\ndata-web-app-1\ndata-web-app-2\n'})}),"\n",(0,s.jsx)(n.h3,{id:"pod-and-pvc-lifecycle",children:"Pod and PVC Lifecycle"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. Delete Pod, PVC is not deleted\nkubectl delete pod web-app-0\n# Pod is recreated and automatically binds back to the original PVC, data is retained\n\n# 2. Delete StatefulSet, retain PVCs (recommended)\nkubectl delete statefulset web-app --cascade=orphan\n# PVCs and data are retained\n\n# 3. Delete StatefulSet and Pods, but retain PVCs\nkubectl delete statefulset web-app\n# PVCs need manual deletion\n\n# 4. Manually delete PVC\nkubectl delete pvc data-web-app-0\n"})}),"\n",(0,s.jsx)(n.h3,{id:"scaling",children:"Scaling"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. Scale up (increase replicas)\nkubectl scale statefulset web-app --replicas=5\n# Automatically creates web-app-3, web-app-4 and corresponding PVCs\n\n# 2. Scale down (decrease replicas)\nkubectl scale statefulset web-app --replicas=2\n# web-app-2 is deleted, but PVC data-web-app-2 is retained\n\n# 3. Scale up again\nkubectl scale statefulset web-app --replicas=3\n# web-app-2 is recreated and binds back to data-web-app-2, data is restored\n"})}),"\n",(0,s.jsx)(n.h3,{id:"fuse-process-sharing",children:"FUSE Process Sharing"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# Conditions for multiple PVs to share a FUSE process:\n# 1. Same master-addrs\n# 2. Same curvine-path\n\n# Example: These two PVs will share a FUSE process\nPV1:\n  master-addrs: "10.0.0.1:8995"\n  curvine-path: "/shared-data"\n\nPV2:\n  master-addrs: "10.0.0.1:8995"\n  curvine-path: "/shared-data"\n\n# These two PVs will have independent FUSE processes\nPV3:\n  curvine-path: "/data-1"\n\nPV4:\n  curvine-path: "/data-2"\n'})})]})}function o(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>l});var t=a(6540);const s={},r=t.createContext(s);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);