"use strict";(self.webpackChunkcurvine_doc=self.webpackChunkcurvine_doc||[]).push([[6165],{7875:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"User-Manuals/csi","title":"CSI Driver","description":"To facilitate quick integration with Curvine in cloud-native environments, Curvine provides CSI driver support. Your Pod containers can access Curvine through PV (Persistent Volume) without requiring application modifications, enabling the use of Curvine\'s caching capabilities.","source":"@site/docs/3-User-Manuals/07-csi.md","sourceDirName":"3-User-Manuals","slug":"/User-Manuals/csi","permalink":"/docs/User-Manuals/csi","draft":false,"unlisted":false,"editUrl":"https://github.com/curvineio/curvine-doc/edit/main/docs/3-User-Manuals/07-csi.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Configuration Reference","permalink":"/docs/User-Manuals/conf"},"next":{"title":"Fuse Mode Access","permalink":"/docs/User-Manuals/fuse"}}');var r=i(4848),t=i(8453);const c={},l="CSI Driver",a={},o=[{value:"Deploy CSI",id:"deploy-csi",level:2},{value:"PVC+Static PV",id:"pvcstatic-pv",level:2},{value:"PVC+Dynamic PV",id:"pvcdynamic-pv",level:2},{value:"Creating a Pod",id:"creating-a-pod",level:2},{value:"Verification",id:"verification",level:2},{value:"Curvine CSI Driver Helm Chart",id:"curvine-csi-driver-helm-chart",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Installation",id:"installation",level:3},{value:"Add Helm Repository (if available)",id:"add-helm-repository-if-available",level:4},{value:"Install from Local Chart",id:"install-from-local-chart",level:4},{value:"Configuration",id:"configuration",level:3},{value:"Customization",id:"customization",level:3},{value:"Custom Curvine Configuration",id:"custom-curvine-configuration",level:4},{value:"Custom Images",id:"custom-images",level:4},{value:"Node Tolerations",id:"node-tolerations",level:4},{value:"Usage",id:"usage",level:3},{value:"Uninstallation",id:"uninstallation",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"Check CSI Driver Status",id:"check-csi-driver-status",level:4},{value:"Check Logs",id:"check-logs",level:4},{value:"Common Issues",id:"common-issues",level:4}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"csi-driver",children:"CSI Driver"})}),"\n",(0,r.jsxs)(n.p,{children:["To facilitate quick integration with Curvine in cloud-native environments, Curvine provides CSI driver support. Your Pod containers can access Curvine through ",(0,r.jsx)(n.code,{children:"PV"})," (Persistent Volume) without requiring application modifications, enabling the use of Curvine's caching capabilities."]}),"\n",(0,r.jsx)(n.p,{children:"The Curvine CSI driver follows the standard CSI specification and includes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CSI Controller"}),", deployed in ",(0,r.jsx)(n.code,{children:"Deployment"})," mode or ",(0,r.jsx)(n.code,{children:"Statefulset"})," mode"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CSI Node Plugin"}),", deployed in ",(0,r.jsx)(n.code,{children:"DaemonSet"})," mode"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Deployment scripts are located in the ",(0,r.jsx)(n.code,{children:"curvine-csi/deploy"})," directory. Execute:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl create -f curvine-csi/deploy\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"warning",children:[(0,r.jsxs)(n.p,{children:["Currently, the ",(0,r.jsx)(n.code,{children:"curvine-csi"})," depends on a fuse version that only supports cluster configuration file connection method. Therefore, in ",(0,r.jsx)(n.code,{children:"deploy/configmap.yaml"}),", you need to fill in the ",(0,r.jsx)(n.code,{children:"master_addrs"})," option with the real curvine master address."]}),(0,r.jsx)(n.p,{children:"This is a temporary solution. If you want to try it out, you can test it. We are working on supporting custom parameters for fuse, and various configuration parameters for connecting to the cluster will be customized through storageclass or pv attributes. This will be released soon, stay tuned!"}),(0,r.jsx)(n.p,{children:"The CSI driver is still in rapid iteration. If you encounter issues during use, welcome to submit an issue \ud83d\ude04!"})]}),"\n",(0,r.jsx)(n.p,{children:"After successful deployment, you will see the following pods:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"NAME                     READY   STATUS    RESTARTS   AGE\ncurvine-controller-0     4/4     Running   0          4h32m\ncurvine-csi-node-jbvmt   3/3     Running   0          4h32m\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"csi-arch",src:i(9556).A+"",width:"1674",height:"1024"})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"The Curvine CSI driver depends on fuse, which is established by the CSI node plugin. Since CSI driver upgrades will interrupt the fuse service, proceed with caution."})}),"\n",(0,r.jsx)(n.h2,{id:"deploy-csi",children:"Deploy CSI"}),"\n",(0,r.jsx)(n.p,{children:"First, deploy the CSI driver in the k8s cluster and ensure that the CSI node plugin is running properly."}),"\n",(0,r.jsx)(n.h2,{id:"pvcstatic-pv",children:"PVC+Static PV"}),"\n",(0,r.jsx)(n.p,{children:"You can manually create a static PV and bind the PVC to the static PV. Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: curvine-pv\n  labels:\n    type: curvine\nspec:\n  storageClassName: curvine-sc\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  csi:\n    driver: curvine\n    volumeHandle: curvine-volume-1\n    volumeAttributes:\n      curvinePath: "/"\n      type: "Directory" # Using Directory type requires that the path must already exist\n'})}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"The following fields are required:"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"volumeAttributes.curvinePath"})," must be ",(0,r.jsx)(n.code,{children:"/"}),", as currently Curvine fuse only supports mounting the root path"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"volumeAttributes.type"})," as ",(0,r.jsx)(n.code,{children:"Directory"})," indicates the path already exists. ",(0,r.jsx)(n.code,{children:"DirectoryOrCreate"})," indicates the path will be automatically created if it doesn't exist"]}),"\n"]})]}),"\n",(0,r.jsx)(n.h2,{id:"pvcdynamic-pv",children:"PVC+Dynamic PV"}),"\n",(0,r.jsxs)(n.p,{children:["To use dynamic PV, you need to define a ",(0,r.jsx)(n.code,{children:"StorageClass"})," first."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"StorageClass"})," example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: curvine-sc\nprovisioner: curvine\nreclaimPolicy: Delete\nvolumeBindingMode: Immediate\nallowVolumeExpansion: true\nparameters:\n  curvinePath: "/"\n  type: "DirectoryOrCreate" #"DirectoryOrCreate" or "Directory"\n'})}),"\n",(0,r.jsx)(n.p,{children:"PVC example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: curvine-pvc\nspec:\n  storageClassName: curvine-sc\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n"})}),"\n",(0,r.jsxs)(n.p,{children:["After creating the PVC, a PV will be automatically created with the status ",(0,r.jsx)(n.code,{children:"Bound"}),", as shown below:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pvc\nNAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE\ncurvine-pvc   Bound    pvc-fce87a49-828f-43d2-8360-7901b0b5f886   5Gi        RWO            curvine-sc     <unset>                 16s\n"})}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-pod",children:"Creating a Pod"}),"\n",(0,r.jsx)(n.p,{children:"Mount the Curvine volume to a pod. Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: curvine-csi-pod\n  labels:\n    app: curvine-csi-pod\nspec:\n  containers:\n    - name: web-server\n      image: nginx\n      ports:\n        - containerPort: 80\n          name: "http-server"\n      volumeMounts:\n        - mountPath: "/usr/share/nginx/html"\n          name: curvine-storage\n  volumes:\n    - name: curvine-storage\n      persistentVolumeClaim:\n        claimName: curvine-pvc\n'})}),"\n",(0,r.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,r.jsxs)(n.p,{children:["On a cluster with Curvine running, you can manually create a file in the root path, such as 'index.html'. You can use the ",(0,r.jsx)(n.code,{children:"fuse"})," feature; by default, the fuse mounted by Curvine is at the ",(0,r.jsx)(n.code,{children:"/curvine-fuse"})," path."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ ls /curvine-fuse\nindex.html\n"})}),"\n",(0,r.jsx)(n.p,{children:"Check in the pod:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl exec curvine-test-pod -n default -- /usr/bin/cat /usr/share/nginx/html/index.html\n<html>\n        hello curvine csi\n</html>\n"})}),"\n",(0,r.jsx)(n.h2,{id:"curvine-csi-driver-helm-chart",children:"Curvine CSI Driver Helm Chart"}),"\n",(0,r.jsx)(n.p,{children:"Using Helm chart to deploy the Curvine CSI (Container Storage Interface) driver on a Kubernetes cluster."}),"\n",(0,r.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Kubernetes 1.19+"}),"\n",(0,r.jsx)(n.li,{children:"Helm 3.0+"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"installation",children:"Installation"}),"\n",(0,r.jsx)(n.h4,{id:"add-helm-repository-if-available",children:"Add Helm Repository (if available)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"helm repo add curvine https://charts.curvine.io\nhelm repo update\n"})}),"\n",(0,r.jsx)(n.h4,{id:"install-from-local-chart",children:"Install from Local Chart"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Install with default values\nhelm install curvine-csi ./curvine-csi\n\n# Install with custom values\nhelm install curvine-csi ./curvine-csi -f custom-values.yaml\n\n# Install in specific namespace\nhelm install curvine-csi ./curvine-csi --namespace curvine-system --create-namespace\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The following table lists the configurable parameters and their default values:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Parameter"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Default"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"global.namespace"})}),(0,r.jsx)(n.td,{children:"Namespace to deploy resources"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"default"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"image.repository"})}),(0,r.jsx)(n.td,{children:"Curvine CSI image repository"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"curvine/curvine-csi"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"image.tag"})}),(0,r.jsx)(n.td,{children:"Curvine CSI image tag"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"latest"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"image.pullPolicy"})}),(0,r.jsx)(n.td,{children:"Image pull policy"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Always"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"csiDriver.name"})}),(0,r.jsx)(n.td,{children:"CSI driver name"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"curvine"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"csiDriver.attachRequired"})}),(0,r.jsx)(n.td,{children:"Whether attach is required"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"true"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"csiDriver.podInfoOnMount"})}),(0,r.jsx)(n.td,{children:"Whether pod info on mount"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"controller.replicas"})}),(0,r.jsx)(n.td,{children:"Number of controller replicas"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"controller.priorityClassName"})}),(0,r.jsx)(n.td,{children:"Priority class for controller"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"system-cluster-critical"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"node.priorityClassName"})}),(0,r.jsx)(n.td,{children:"Priority class for node"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"system-node-critical"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rbac.create"})}),(0,r.jsx)(n.td,{children:"Create RBAC resources"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"true"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"configMap.name"})}),(0,r.jsx)(n.td,{children:"ConfigMap name"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"curvine-config"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"customization",children:"Customization"}),"\n",(0,r.jsx)(n.h4,{id:"custom-curvine-configuration",children:"Custom Curvine Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["You can customize the Curvine configuration by modifying the ",(0,r.jsx)(n.code,{children:"configMap.data.curvineClusterToml"})," value:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'configMap:\n  data:\n    curvineClusterToml: |\n      [client]\n      master_addrs = [\n          { hostname = "your-master-host", port = 8995 }\n      ]\n      \n      [log]\n      level = "debug"\n      log_dir = "stdout"\n      file_name = "curvine.log"\n'})}),"\n",(0,r.jsx)(n.h4,{id:"custom-images",children:"Custom Images"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"image:\n  repository: your-registry/curvine-csi\n  tag: v1.0.0\n  pullPolicy: IfNotPresent\n\ncontroller:\n  sidecars:\n    provisioner:\n      image: registry.k8s.io/sig-storage/csi-provisioner:v3.6.0\n    attacher:\n      image: registry.k8s.io/sig-storage/csi-attacher:v4.5.0\n"})}),"\n",(0,r.jsx)(n.h4,{id:"node-tolerations",children:"Node Tolerations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'node:\n  tolerations:\n    - key: "node-role.kubernetes.io/master"\n      operator: "Exists"\n      effect: "NoSchedule"\n    - key: "node-role.kubernetes.io/control-plane"\n      operator: "Exists"\n      effect: "NoSchedule"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,r.jsx)(n.p,{children:"After installation, create a StorageClass:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: curvine-csi\nprovisioner: curvine\nparameters:\n  # Add Curvine-specific parameters\nvolumeBindingMode: WaitForFirstConsumer\n"})}),"\n",(0,r.jsx)(n.p,{children:"Create a PVC:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: test-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: curvine-csi\n"})}),"\n",(0,r.jsx)(n.h3,{id:"uninstallation",children:"Uninstallation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"helm uninstall curvine-csi\n"})}),"\n",(0,r.jsx)(n.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h4,{id:"check-csi-driver-status",children:"Check CSI Driver Status"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl get csidriver curvine\nkubectl get pods -l app.kubernetes.io/name=curvine-csi\n"})}),"\n",(0,r.jsx)(n.h4,{id:"check-logs",children:"Check Logs"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Controller logs\nkubectl logs -l app=curvine-csi-controller -c csi-plugin\n\n# Node logs\nkubectl logs -l app=curvine-csi-node -c csi-plugin\n"})}),"\n",(0,r.jsx)(n.h4,{id:"common-issues",children:"Common Issues"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CSI Driver not registered"}),": Check if the node-driver-registrar sidecar is running"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mount failures"}),": Verify Curvine cluster connectivity and configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Permission issues"}),": Ensure proper RBAC permissions are granted"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>l});var s=i(6540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}},9556:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/csi-arch-38a126a40b84a3085e337742ee412d2a.png"}}]);